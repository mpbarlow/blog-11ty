<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

    <meta name="generator" content="Eleventy v3.1.2" />
    <meta property="og:locale" content="en_GB" />
    <meta property="og:site_name" content="barlow.dev" />
    <meta property="og:url" content="https://barlow.dev/posts/network-woes-with-raspberry-pi/" />
    <meta property="og:title" content="Network woes with my Raspberry Pi media server - barlow.dev" />
    <meta property="og:type" content="blog" />
    
    <meta property="og:description" content="OpenMediaVault vs. Tailscale. Whoever wins, I lose...my little remaining hair" />
    <meta name="description" content="OpenMediaVault vs. Tailscale. Whoever wins, I lose...my little remaining hair" />
    

    <link rel="stylesheet" href="/css/layout.css" />
    
    <link rel="stylesheet" href="/css/post.css" />
    
    <link rel="stylesheet" href="/css/prism.css" />
    
    <link rel="icon" type="image/png" href="/img/favicon.png" />
    <link rel="canonical" href="https://barlow.dev/posts/network-woes-with-raspberry-pi/" />
    <link rel="alternate" type="application/atom+xml" href="https://barlow.dev/feed.xml" title="RSS Feed" />

    <title>Network woes with my Raspberry Pi media server - barlow.dev</title>
  </head>

  <body>
    <nav id="header-links">
      <a href="/">Home</a>
      <a href="/posts/">Posts</a>
      <a href="/tags/">Tags</a>
      <a href="/feed.xml">RSS</a>
    </nav>

    <main>
<article>
  <header>
    <h1>Network woes with my Raspberry Pi media server</h1>
    
    <h4>OpenMediaVault vs. Tailscale. Whoever wins, I lose...my little remaining hair</h4>
    

    <aside>
      <p>13th May 2024 &bull; 4 minute read</p>

      <p id="tag-list">
        Tags: 
        <a href="/tags/linux/" title="See all posts tagged 'linux'">linux</a>
        
        <a href="/tags/networking/" title="See all posts tagged 'networking'">networking</a>
        
        <a href="/tags/openmediavault/" title="See all posts tagged 'openmediavault'">openmediavault</a>
        
        <a href="/tags/raspberrypi/" title="See all posts tagged 'raspberrypi'">raspberrypi</a>
        
        <a href="/tags/tailscale/" title="See all posts tagged 'tailscale'">tailscale</a>
        
      </p>
    </aside>
  </header>

  <section><h2>For desperate and frustrated people</h2>
<p>I’ve lost two seperate evenings to this so I might as well get a quick blog post out of it.</p>
<p><strong>If you don’t need my life story, here’s the tl;dr:</strong></p>
<ul>
<li>OpenMediaVault expects to be in sole control of the machine it runs on when installed on bare metal (i.e. not as a Docker container)</li>
<li>It will pick up the <code>tailscale0</code> interface and attempt to create a Netplan config for it, but because that interface doesn’t have a MAC address, the config file will be malformed and prevent all networking from starting up on next boot</li>
<li>Delete or move <code>/etc/netplan/20-openmediavault-tailscale0.yaml</code> and reboot</li>
</ul>
<h2>My setup</h2>
<p>I’m running a Raspberry Pi 4 connected to a couple of USB hard drives as a quick-and-dirty home media server. I run OpenMediaVault because it has a nice web interface and I’m too lazy to set the Samba shares up myself, and it’s on my Tailscale tailnet so I can stream stuff away from home. It works very nicely and was not a lot of cost or effort to set up.</p>
<h2>The problem</h2>
<p>A few weeks ago we had a brief power cut and I lost my year+ uptime streak for the Pi, which had been running dutifully since the day I bought it. However, when power returned I could no longer access my media nor SSH in, either via Tailscale or directly over the LAN. It wasn’t showing up as a connected device on my router either.</p>
<p>Fearing something had fried, I got it connected to a monitor (really glad I bought that micro-HDMI cable!) to find that it was completely fine, but that the <code>eth0</code> interface was down. Bringing it up manually didn’t yield much; it wouldn’t get an IP and my router just wasn’t seeing it.</p>
<p>I can use Linux well enough, and set up and debug typical webserver stuff thanks to my day job, but when it comes to low-level OS and hardware config stuff, I’m very much out of my depth. After a few hours of fruitless Googling, I gave up and assumed that something on the SD card must have been corrupted by the power outage. That seemed unlikely, but SD corruption does seem to be fairly common with Pis and I didn’t have much else to go on.</p>
<p>So I wiped the SD card, flashed a new OS image, set Tailscale and OMV up from scratch again, and all was well with the world.</p>
<p>Today I got a new drive to add to the pool, so I powered the Pi off (properly) so I could rejig what was plugged into which port. I turned it back on and...no network again. Connected it back up to a monitor and, once again, <code>eth0</code> was down and completely uncooperative.</p>
<h2>The solution</h2>
<p>Driven by a suspicion now that this was not some random corruption and would keep happening, and that I <em>really</em> couldn’t be arsed to set everything up from scratch again, I set off on another aimless Google journey.</p>
<p>Among some sage advice to people with similar problems, I came across a suggestion to check the output from <code>journalctl</code>. This is probably incredibly obvious to people who know more stuff about Linux, but as they say: every day’s a school day.</p>
<p>This gave me something—very helpfully rendered in bright red—that led to the solution: <code>netplan returned non-zero exit status 1</code>.</p>
<p>After some quick learning about what Netplan is and how I might find the exact issue, I found (with some excitement) that it was due to a malformed YAML file:</p>
<p><img src="/img/network_problem_solved.jpeg" alt="An iMessage conversation of the moment I found the problem, with an error message from netplan apply"></p>
<p>It would appear that, either on installation or when changing some config, OpenMediaVault generates a set of Netplan configs for each network interface on the machine. It includes the MAC address, but because <code>tailscale0</code> isn’t a physical device and doesn’t <em>have</em> a MAC address, the resulting file is invalid.</p>
<p>I moved this file elsewhere, rebooted, and everything worked perfectly again. I’ve tried connecting via Tailscale outside of my LAN and it seems to still work perfectly fine, so this file doesn’t appear to be necessary at all.</p>
<p>I’m unsure if the file will come back as a result of some change or update, but at least I know how to fix it now. If it <em>does</em> come back, I’ll probably look at a Dockerised solution for OMV. It looks like OMV expects to be the only thing managing the machine, and not for someone to be fiddling around introducing new network interfaces. Amusingly, both of the times this has happened have been so delayed because I just never rebooted the Pi after setting up OMV. If I had, I’d have ran into the issue immediately and probably put the pieces together much quicker.</p>
<p>Anyway, I couldn’t find any reports of this exact problem, so here’s hoping this will be of help to someone out there, even if it’s just me in the future.</p>
</section>
</article>
</main>

    <footer>
      <nav id="all-post-links"><a href="/posts/">All posts</a> &bull; <a href="/tags/">By tag</a></nav>
      <nav id="social-links">
        <a
  rel="me"
  href="https://mastodon.social/@mpbarlow"
  target="_blank"
  title="Toot me on Mastodon"
  class="footer-icon-link"
>
  <img
    src="/img/mastodon.png"
    srcset="/img/mastodon_2x.png 2x, /img/mastodon_3x.png 3x"
    alt="A pixel art elephant bearing the Mastodon logo"
    class="footer-icon"
  />
  <img
    src="/img/mastodon_selected.png"
    srcset="/img/mastodon_selected_2x.png 2x, /img/mastodon_selected_3x.png 3x"
    alt="A pixel art elephant bearing the Mastodon logo"
    class="footer-icon-selected"
  />
</a>
 <a href="https://www.instagram.com/mattpbarlow" target="_blank" title="Dog pix" class="footer-icon-link">
  <img
    src="/img/instagram.png"
    srcset="/img/instagram_2x.png 2x, /img/instagram_3x.png 3x"
    alt="A pixel art iPhone taking a photo of the Instagram logo"
    class="footer-icon"
  />
  <img
    src="/img/instagram_selected.png"
    srcset="/img/instagram_selected_2x.png 2x, /img/instagram_selected_3x.png 3x"
    alt="A pixel art iPhone taking a photo of the Instagram logo"
    class="footer-icon-selected"
  />
</a>
 <a href="https://github.com/mpbarlow" target="_blank" title="Fork me on GitHub" class="footer-icon-link">
  <img
    src="/img/github.png"
    srcset="/img/github_2x.png 2x, /img/github_3x.png 3x"
    alt="A pixel art MacBook displaying the Git logo"
    class="footer-icon"
  />
  <img
    src="/img/github_selected.png"
    srcset="/img/github_selected_2x.png 2x, /img/github_selected_3x.png 3x"
    alt="A pixel art MacBook displaying the Git logo"
    class="footer-icon-selected"
  />
</a>

      </nav>
      <p>&copy; MMXXV Matt Barlow</p>
    </footer>
  </body>
</html>
